<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CAD Santana de Parnaíba - Escala e Trocas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .gradient-cad { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); }
        .escala-container { min-height: 400px; border: 2px dashed #cbd5e1; border-radius: 2rem; display: flex; align-items: center; justify-content: center; overflow: hidden; background: #fff; }
        canvas { max-width: 100%; height: auto; }
    </style>
</head>
<body class="pb-20">

    <header class="gradient-cad text-white py-6 shadow-2xl mb-8">
        <div class="container mx-auto px-6 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-4">
                <div class="bg-amber-500 p-2.5 rounded-xl shadow-lg">
                    <i class="fa-solid fa-scale-balanced text-slate-900 text-xl"></i>
                </div>
                <div>
                    <h1 class="text-lg font-black uppercase tracking-tight">Comissão de Dativos</h1>
                    <p class="text-amber-400 text-[10px] font-bold uppercase tracking-[0.2em]">Santana de Parnaíba</p>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right hidden md:block text-slate-400 text-xs font-mono">
                    <p id="relogio"></p>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 grid grid-cols-1 xl:grid-cols-12 gap-8">
        
        <div class="xl:col-span-4 space-y-6">
            
            <div class="bg-white p-6 rounded-[2rem] shadow-xl border border-slate-200">
                <h2 class="text-xs font-black text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-file-arrow-up text-amber-500"></i> Atualizar Escala Mensal
                </h2>
                <input type="file" id="uploadFile" class="hidden" accept="image/*,application/pdf" onchange="processarArquivo(this)">
                <label for="uploadFile" class="w-full flex flex-col items-center justify-center p-6 border-2 border-dashed border-slate-200 rounded-2xl cursor-pointer hover:bg-slate-50 transition-all">
                    <i class="fa-solid fa-cloud-arrow-up text-slate-300 text-2xl mb-2"></i>
                    <p class="text-xs font-bold text-slate-500 text-center">Clique para subir a Escala de Fevereiro (JPG ou PDF)</p>
                </label>
            </div>

            <div class="bg-indigo-900 p-6 rounded-[2rem] shadow-xl text-white">
                <h2 class="text-xs font-black text-indigo-300 uppercase tracking-widest mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-robot"></i> Lançamento Inteligente
                </h2>
                <textarea id="textoIA" rows="4" 
                    placeholder="Cole a mensagem aqui... Ex: Dra. Fernanda substitui a Dra. Claudia dia 22/02"
                    class="w-full p-4 bg-white/10 border border-white/20 rounded-2xl outline-none focus:border-amber-500 transition-all text-sm italic placeholder:text-white/30 mb-4"></textarea>
                <button onclick="iaRegistrar()" class="w-full bg-amber-500 hover:bg-amber-400 text-slate-900 py-4 rounded-xl font-black text-xs uppercase tracking-widest shadow-lg transition-all active:scale-95">
                    Processar Mensagem
                </button>
            </div>
        </div>

        <div class="xl:col-span-8 space-y-8">
            
            <div class="bg-white p-4 rounded-[2.5rem] shadow-xl border border-slate-200">
                <div class="flex justify-between items-center px-4 py-2 mb-2">
                    <h3 class="font-black text-slate-800 uppercase text-xs tracking-widest">Escala Vigente</h3>
                    <span id="statusEscala" class="text-[10px] font-bold text-slate-400">Nenhum arquivo carregado</span>
                </div>
                <div id="visualizador" class="escala-container">
                    <div id="placeholderEscala" class="text-center p-10">
                        <i class="fa-solid fa-image text-slate-200 text-6xl mb-4"></i>
                        <p class="text-slate-400 font-medium">A escala aparecerá aqui após o upload</p>
                    </div>
                    <img id="imgExibicao" class="hidden w-full h-full object-contain">
                    <iframe id="pdfExibicao" class="hidden w-full h-[600px] border-none"></iframe>
                </div>
            </div>

            <div class="bg-white rounded-[2.5rem] shadow-xl overflow-hidden border border-slate-200">
                <div class="p-6 bg-slate-50 border-b border-slate-100">
                    <h3 class="font-black text-slate-400 text-[10px] uppercase tracking-widest">Alterações na Escala Original</h3>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <tbody id="listaTrocas" class="divide-y divide-slate-50">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>
    </main>

    <script>
        let trocas = JSON.parse(localStorage.getItem('cad_trocas_v5')) || [];
        
        // Carregar arquivo salvo ao iniciar
        window.onload = () => {
            const salvo = localStorage.getItem('cad_arquivo_binario');
            const tipo = localStorage.getItem('cad_arquivo_tipo');
            if(salvo) exibirArquivo(salvo, tipo);
            renderizarTrocas();
        };

        function processarArquivo(input) {
            const file = input.files[0];
            if(!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const base64 = e.target.result;
                localStorage.setItem('cad_arquivo_binario', base64);
                localStorage.setItem('cad_arquivo_tipo', file.type);
                exibirArquivo(base64, file.type);
                document.getElementById('statusEscala').innerText = "Vigente: " + file.name;
            };
            reader.readAsDataURL(file);
        }

        function exibirArquivo(src, tipo) {
            const img = document.getElementById('imgExibicao');
            const pdf = document.getElementById('pdfExibicao');
            const placeholder = document.getElementById('placeholderEscala');

            placeholder.classList.add('hidden');
            
            if(tipo.includes('image')) {
                img.src = src;
                img.classList.remove('hidden');
                pdf.classList.add('hidden');
            } else {
                pdf.src = src;
                pdf.classList.remove('hidden');
                img.classList.add('hidden');
            }
        }

        function iaRegistrar() {
            const txt = document.getElementById('textoIA').value;
            if(!txt) return;

            const dataMatch = txt.match(/(\d{1,2}\/\d{1,2})/);
            const nomes = txt.match(/(Dr\.|Dra\.)\s?([A-Z][a-z]+)/g);

            let sainte = nomes && nomes.length > 1 ? nomes[1] : "Não identificado";
            let entrante = nomes && nomes.length > 0 ? nomes[0] : "Não identificado";

            const nova = {
                data: dataMatch ? dataMatch[0] : "--/--",
                sainte: sainte,
                entrante: entrante
            };

            trocas.unshift(nova);
            localStorage.setItem('cad_trocas_v5', JSON.stringify(trocas));
            document.getElementById('textoIA').value = "";
            renderizarTrocas();
        }

        function renderizarTrocas() {
            const lista = document.getElementById('listaTrocas');
            lista.innerHTML = trocas.length ? "" : "<tr><td class='p-10 text-center text-slate-300 italic'>Nenhuma alteração registrada.</td></tr>";
            
            trocas.forEach((t, i) => {
                lista.innerHTML += `
                    <tr class="hover:bg-slate-50 transition-all">
                        <td class="px-8 py-5 font-black text-slate-400 text-xs">${t.data}</td>
                        <td class="px-8 py-5">
                            <div class="flex items-center gap-4">
                                <span class="text-red-400 font-bold text-sm"><s>${t.sainte}</s></span>
                                <i class="fa-solid fa-arrow-right text-slate-300 text-xs"></i>
                                <span class="text-emerald-600 font-black text-sm underline underline-offset-4">${t.entrante}</span>
                            </div>
                        </td>
                        <td class="px-8 py-5 text-right">
                            <button onclick="excluir(${i})" class="text-slate-200 hover:text-red-500 transition-colors"><i class="fa-solid fa-trash-can"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        function excluir(i) {
            trocas.splice(i, 1);
            localStorage.setItem('cad_trocas_v5', JSON.stringify(trocas));
            renderizarTrocas();
        }

        setInterval(() => {
            const d = new Date();
            document.getElementById('relogio').innerText = d.toLocaleDateString() + ' | ' + d.toLocaleTimeString();
        }, 1000);
    </script>
</body>
</html>
