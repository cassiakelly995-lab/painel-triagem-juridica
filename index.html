<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA INTELIGENTE CAD - Santana de Parnaíba</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #020617; color: #f8fafc; overflow: hidden; }
        .panel-split { height: calc(100vh - 80px); }
        .escala-view { background: #000; border: 1px solid #1e293b; border-radius: 20px; position: relative; overflow: auto; }
        .ai-terminal { background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(10px); border: 1px solid #334155; border-radius: 30px; }
        .card-troca { border-left: 5px solid #fbbf24; background: #1e293b; transition: 0.3s; animation: slideIn 0.4s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 10px; }
    </style>
</head>
<body>

    <header class="h-20 flex items-center px-8 border-b border-slate-800 bg-slate-950">
        <div class="container mx-auto flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div class="bg-amber-500 text-black p-2 rounded-lg shadow-lg shadow-amber-500/20">
                    <i class="fa-solid fa-brain text-xl"></i>
                </div>
                <div>
                    <h1 class="text-lg font-black uppercase tracking-tighter">CAD Inteligente</h1>
                    <p class="text-amber-500 text-[9px] font-bold tracking-[0.3em] uppercase">Santana de Parnaíba</p>
                </div>
            </div>
            
            <div class="flex gap-4">
                <input type="file" id="fileInput" class="hidden" accept="image/*,application/pdf" onchange="uploadEscala(this)">
                <button onclick="document.getElementById('fileInput').click()" class="bg-slate-800 hover:bg-slate-700 text-white px-6 py-2 rounded-full text-[10px] font-black uppercase border border-slate-600 transition-all flex items-center gap-2">
                    <i class="fa-solid fa-file-import"></i> Carregar Escala de Fevereiro
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto p-4 panel-split grid grid-cols-1 lg:grid-cols-12 gap-6">
        
        <div class="lg:col-span-6 flex flex-col gap-3">
            <span class="text-[10px] font-black text-slate-500 uppercase ml-2 italic">Visualização da Escala Oficial</span>
            <div id="escalaContainer" class="escala-view h-full flex items-center justify-center">
                <div id="placeholder" class="text-center opacity-30 p-10">
                    <i class="fa-solid fa-file-arrow-up text-6xl mb-4"></i>
                    <p class="text-sm font-bold">A ESCALA APARECERÁ AQUI</p>
                </div>
                <img id="renderImg" class="hidden w-full h-auto">
                <embed id="renderPdf" class="hidden w-full h-full" type="application/pdf">
            </div>
        </div>

        <div class="lg:col-span-6 flex flex-col gap-6">
            
            <div class="ai-terminal p-6 shadow-2xl">
                <label class="text-[10px] font-black text-amber-500 uppercase tracking-widest block mb-3">Identificador de Trocas (Cole o texto abaixo)</label>
                <textarea id="rawText" rows="2" 
                    placeholder="Ex: Dra. Kelly entra no lugar da Dra. Silvia dia 15/02..."
                    class="w-full bg-transparent text-white text-xl font-bold outline-none placeholder:text-slate-700 resize-none"></textarea>
                <div class="flex justify-end mt-4">
                    <button onclick="processarIA()" class="bg-white text-black px-10 py-3 rounded-full font-black text-xs uppercase tracking-widest hover:bg-amber-500 transition-all active:scale-95">
                        Identificar e Registrar
                    </button>
                </div>
            </div>

            <div class="flex-grow overflow-y-auto pr-2">
                <h3 class="text-[10px] font-black text-slate-500 uppercase tracking-widest mb-4 ml-2">Substituições Identificadas</h3>
                <div id="listaTrocas" class="space-y-4 text-white">
                    </div>
            </div>
        </div>
    </main>

    <script>
        let db = JSON.parse(localStorage.getItem('cad_pro_v1')) || [];

        // FUNÇÃO DE UPLOAD CORRIGIDA
        function uploadEscala(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const data = e.target.result;
                localStorage.setItem('escala_data', data);
                localStorage.setItem('escala_tipo', file.type);
                exibirEscala();
            };
            reader.readAsDataURL(file);
        }

        function exibirEscala() {
            const data = localStorage.getItem('escala_data');
            const tipo = localStorage.getItem('escala_tipo');
            if (!data) return;

            document.getElementById('placeholder').style.display = 'none';
            const img = document.getElementById('renderImg');
            const pdf = document.getElementById('renderPdf');

            if (tipo.includes('image')) {
                img.src = data; img.classList.remove('hidden');
                pdf.classList.add('hidden');
            } else {
                pdf.src = data; pdf.classList.remove('hidden');
                img.classList.add('hidden');
            }
        }

        // IA SUPER INTELIGENTE DE IDENTIFICAÇÃO DE NOMES
        function processarIA() {
            const texto = document.getElementById('rawText').value;
            if (!texto) return;

            // Busca nomes após Dra. ou Dr. (Identifica quem trocou com quem)
            const regexNomes = /(?:Dra?\.\s?)([A-ZÀ-Ú][a-zà-ú]+(?:\s[A-ZÀ-Ú][a-zà-ú]+)*)/g;
            const nomesEncontrados = [...texto.matchAll(regexNomes)];
            const dataMatch = texto.match(/(\d{1,2}\/\d{1,2})/);

            let entrante = "Identificando...";
            let sainte = "Identificando...";

            if (nomesEncontrados.length >= 2) {
                // Lógica Inteligente: Quem vem primeiro na frase de troca geralmente é quem assume
                // Ex: "Dra. A substitui Dra. B" ou "Dra. A no lugar da Dra. B"
                entrante = "Dra. " + nomesEncontrados[0][1];
                sainte = "Dra. " + nomesEncontrados[1][1];
            }

            const novaTroca = {
                id: Date.now(),
                data: dataMatch ? dataMatch[0] : "FEV",
                entrante: entrante,
                sainte: sainte
            };

            db.unshift(novaTroca);
            localStorage.setItem('cad_pro_v1', JSON.stringify(db));
            document.getElementById('rawText').value = "";
            renderizarTrocas();
        }

        function renderizarTrocas() {
            const container = document.getElementById('listaTrocas');
            container.innerHTML = db.length ? '' : '<p class="text-slate-700 italic text-center p-10 font-bold">NENHUMA TROCA NO SISTEMA</p>';

            db.forEach(t => {
                container.innerHTML += `
                    <div class="card-troca p-6 rounded-3xl flex items-center justify-between shadow-lg">
                        <div class="flex items-center gap-6">
                            <div class="bg-slate-900 border border-slate-700 p-3 rounded-2xl text-center min-w-[70px]">
                                <span class="text-[9px] font-black text-amber-500 block uppercase leading-none">DIA</span>
                                <span class="text-xl font-black">${t.data}</span>
                            </div>
                            <div class="flex items-center gap-4">
                                <div>
                                    <span class="text-[8px] font-bold text-slate-500 uppercase block">Sai do Plantão</span>
                                    <span class="text-sm font-medium text-slate-400"><s>${t.sainte}</s></span>
                                </div>
                                <i class="fa-solid fa-arrow-right-arrow-left text-amber-500 opacity-30"></i>
                                <div>
                                    <span class="text-[8px] font-black text-emerald-400 uppercase block tracking-widest">Vai no Lugar</span>
                                    <span class="text-lg font-black text-white uppercase">${t.entrante}</span>
                                </div>
                            </div>
                        </div>
                        <button onclick="excluir(${t.id})" class="text-slate-600 hover:text-red-500 transition-all ml-4">
                            <i class="fa-solid fa-trash-can"></i>
                        </button>
                    </div>
                `;
            });
        }

        function excluir(id) {
            db = db.filter(x => x.id !== id);
            localStorage.setItem('cad_pro_v1', JSON.stringify(db));
            renderizarTrocas();
        }

        // Inicialização
        window.onload = () => {
            exibirEscala();
            renderizarTrocas();
        };
    </script>
</body>
</html>
