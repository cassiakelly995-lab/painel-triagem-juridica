<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0">
    <title>CAD SANTANA | V8 GOD MODE ELITE</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;600;800&display=swap');
        :root { --oab-dark: #070b14; --oab-gold: #c5a36b; --oab-card: #111827; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: var(--oab-dark); color: #f1f5f9; min-height: 100vh; display: flex; flex-direction: column; }
        header { background: #0f172a; border-bottom: 2px solid var(--oab-gold); padding: 15px 20px; flex-shrink: 0; position: sticky; top: 0; z-index: 50; }
        .layout-master { display: flex; flex-direction: column; gap: 20px; padding: 20px; flex-grow: 1; align-items: center; }
        @media (min-width: 1024px) { .layout-master { flex-direction: row; align-items: flex-start; justify-content: center; } }
        .escala-moldura { width: 100%; max-width: 800px; height: 70vh; background: #fff; box-shadow: 0 0 40px rgba(0,0,0,0.7); border-radius: 8px; position: relative; overflow-y: auto; }
        @media (min-width: 1024px) { .escala-moldura { width: 65vh; height: 85vh; } }
        #pdfRenderArea img { width: 100%; height: auto; display: block; border-bottom: 1px solid #eee; }
        .glass-box { background: var(--oab-card); border: 1px solid rgba(197, 163, 107, 0.2); border-radius: 12px; padding: 20px; width: 100%; max-width: 400px; }
        .label-gold { color: var(--oab-gold); font-size: 10px; font-weight: 800; text-transform: uppercase; letter-spacing: 2px; margin-bottom: 10px; display: block; border-bottom: 1px solid rgba(197, 163, 107, 0.1); padding-bottom: 5px; }
        .input-oab { background: #070b14; border: 1px solid rgba(197, 163, 107, 0.3); border-radius: 8px; padding: 12px; width: 100%; color: white; margin-bottom: 8px; font-size: 14px; outline: none; }
        .btn-gold { background: var(--oab-gold); color: #000; font-weight: 900; text-transform: uppercase; padding: 14px; border-radius: 8px; width: 100%; cursor: pointer; }
        .admin-only { display: none !important; }
        .is-admin .admin-only { display: block !important; }
        .item-log { background: rgba(255, 255, 255, 0.03); border-left: 4px solid var(--oab-gold); padding: 12px; border-radius: 8px; margin-bottom: 8px; font-size: 13px; }
    </style>
</head>
<body id="v8app">
    <header>
        <div class="flex justify-between items-center max-w-[1400px] mx-auto">
            <div class="flex items-center gap-4">
                <i class="fa-solid fa-scale-balanced text-2xl text-[#c5a36b]"></i>
                <h1 class="text-white text-sm md:text-lg font-black uppercase italic">CAD Santana</h1>
            </div>
            <button id="btnAdmin" onclick="login()" class="text-white/40 text-[10px] font-black uppercase">Admin</button>
        </div>
    </header>

    <main class="layout-master">
        <div class="escala-moldura" id="viewer">
            <div id="pdfRenderArea"></div>
            <div id="placeholder" class="absolute inset-0 flex flex-col items-center justify-center bg-white text-slate-300 p-10 text-center">
                <i class="fa-solid fa-shield-check text-6xl mb-4 text-slate-200"></i>
                <p class="font-black uppercase text-xs">Aguardando Escala Permanente</p>
            </div>
        </div>

        <div class="glass-box">
            <div class="admin-only">
                <span class="label-gold">Cofre de Escala</span>
                <input type="file" id="fileIn" class="hidden" accept="application/pdf,image/*" onchange="gravarTatuagem(this)">
                <button onclick="document.getElementById('fileIn').click()" class="btn-gold mb-4 w-full">FIXAR ESCALA PARA SEMPRE</button>
                
                <input type="text" id="inD" placeholder="Data" class="input-oab">
                <input type="text" id="inS" placeholder="Sai" class="input-oab">
                <input type="text" id="inE" placeholder="Entra" class="input-oab">
                <button onclick="salvarPermanente()" class="btn-gold w-full mb-4">GRAVAR TROCA</button>
            </div>
            <span class="label-gold">Histórico Inalterável</span>
            <div id="logs" class="max-h-[300px] overflow-y-auto"></div>
        </div>
    </main>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        let db;

        // INICIALIZAÇÃO DO BANCO DE DADOS LOCAL (INDEXEDDB)
        const request = indexedDB.open("CASSIA_V8_ULTRA", 1);
        request.onupgradeneeded = e => {
            db = e.target.result;
            db.createObjectStore("data");
        };
        request.onsuccess = e => { db = e.target.result; carregarTudo(); };

        function login() { if(prompt("Senha:") === "CAD2026") { document.getElementById('v8app').classList.add('is-admin'); } }

        async function gravarTatuagem(input) {
            const file = input.files[0];
            const reader = new FileReader();
            reader.onload = async function() {
                let images = [];
                if (file.type === "application/pdf") {
                    const pdf = await pdfjsLib.getDocument(new Uint8Array(this.result)).promise;
                    for(let i=1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const canvas = document.createElement('canvas');
                        const viewport = page.getViewport({ scale: 2.0 });
                        canvas.height = viewport.height; canvas.width = viewport.width;
                        await page.render({ canvasContext: canvas.getContext('2d'), viewport: viewport }).promise;
                        images.push(canvas.toDataURL('image/webp', 0.8));
                    }
                } else { images.push(this.result); }
                
                const tx = db.transaction("data", "readwrite");
                tx.objectStore("data").put(images, "escala");
                tx.oncomplete = () => location.reload();
            };
            file.type === "application/pdf" ? reader.readAsArrayBuffer(file) : reader.readAsDataURL(file);
        }

        function salvarPermanente() {
            const d = document.getElementById('inD').value, s = document.getElementById('inS').value, e = document.getElementById('inE').value;
            if(!d) return;
            let logs = JSON.parse(localStorage.getItem('logs_v8') || '[]');
            logs.unshift({d, s, e, id: Date.now()});
            localStorage.setItem('logs_v8', JSON.stringify(logs));
            renderLogs();
        }

        function carregarTudo() {
            const tx = db.transaction("data", "readonly");
            tx.objectStore("data").get("escala").onsuccess = e => {
                const res = e.target.result;
                if (res) {
                    const area = document.getElementById('pdfRenderArea'); area.innerHTML = '';
                    res.forEach(src => { const img = new Image(); img.src = src; area.appendChild(img); });
                    document.getElementById('placeholder').style.display = 'none';
                }
            };
            renderLogs();
        }

        function renderLogs() {
            const container = document.getElementById('logs');
            let logs = JSON.parse(localStorage.getItem('logs_v8') || '[]');
            container.innerHTML = logs.map(l => `
                <div class="item-log">
                    <span class="text-gold font-black">[${l.d}]</span> <s>${l.s}</s> → <b>${l.e}</b>
                </div>`).join('');
        }
    </script>
</body>
</html>
